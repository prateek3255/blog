<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Integrating reCAPTCHA with Next.js</title><meta name="description" content="Check out how you can take advantage of Next.js&#39; API routes to get the most out of CAPTCHA solutions like reCAPTCHA and hCaptcha."><link rel="canonical" href="undefined/blog/integrating-recaptcha-with-next/"><link rel="apple-touch-icon" sizes="152x152" href="undefined/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="undefined/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="undefined/favicons/favicon-16x16.png"><link rel="manifest" href="undefined/favicons/site.webmanifest"><link rel="mask-icon" href="undefined/favicons/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><meta name="twitter:title" content="Integrating reCAPTCHA with Next.js"><meta property="twitter:description" content="Check out how you can take advantage of Next.js&#39; API routes to get the most out of CAPTCHA solutions like reCAPTCHA and hCaptcha."><meta name="twitter:image" content="undefined/img/integrating-recaptcha-with-nextjs.png"><meta name="twitter:card" content="summary_large_image"><meta property="og:title" content="Integrating reCAPTCHA with Next.js"><meta property="og:description" content="Check out how you can take advantage of Next.js&#39; API routes to get the most out of CAPTCHA solutions like reCAPTCHA and hCaptcha."><meta property="og:image" content="undefined/img/integrating-recaptcha-with-nextjs.png"><meta property="og:url" content="undefined/blog/integrating-recaptcha-with-next/"><meta property="og:type" content="article"><link rel="stylesheet" type="text/css" href="undefined/css/style.css"><link rel="stylesheet" type="text/css" href="undefined/css/prism-tomorrow.css"><script defer="defer" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/brands.min.js"></script><script defer="defer" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/solid.min.js"></script><script defer="defer" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/fontawesome.min.js"></script><script>function trackTagClick(t){trackEvent("tag_clicked","tags",t)}function trackEvent(t,c,a){console.log("Event",{name:t,category:c,label:a})}</script><script async src="https://unpkg.com/smoothscroll-polyfill/dist/smoothscroll.min.js"></script><script async src="https://unpkg.com/smoothscroll-anchor-polyfill"></script><script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js" defer="defer"></script></head><body><div class="w-full"><nav class="flex items-center justify-center lg:justify-between flex-wrap p-6 lg:px-0 container mx-auto" x-data="navbarData()" @keydown.escape="isOpen = false"><div class="flex items-center"><a href="/" aria-label="logo"><img src="/img/prateek-bitmoji.png" alt="Logo" height="80" width="63.2" class="h-20"></a></div><button x-on:click="handleToggle" type="button" class="ml-auto block lg:hidden px-2 text-primary-500 hover:text-primary-500 focus:outline-none focus:text-primary-500" :class="{ 'transition transform-180': isOpen }" aria-label="Menu"><svg class="h-6 w-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24"><path x-show="isOpen" fill-rule="evenodd" clip-rule="evenodd" d="M18.278 16.864a1 1 0 0 1-1.414 1.414l-4.829-4.828-4.828 4.828a1 1 0 0 1-1.414-1.414l4.828-4.829-4.828-4.828a1 1 0 0 1 1.414-1.414l4.829 4.828 4.828-4.828a1 1 0 1 1 1.414 1.414l-4.828 4.829 4.828 4.828z"/><path x-show="!isOpen" fill-rule="evenodd" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/></svg></button><div class="w-full flex-grow lg:flex lg:items-center lg:w-auto text-center transition-all duration-700 ease-in-out opacity-0 lg:opacity-100" :class="{ 'max-h-80 opacity-100': isOpen, 'max-h-0 opacity-0': !isOpen }" x-show.transition="true"><ul class="pt-6 lg:pt-0 list-reset lg:flex justify-end flex-1 items-center"><li class="nav__item mr-1"><a @click="isOpen = false" class="text-ml inline-block text-gray-500 no-underline hover:text-indigo-500 py-2 px-4" href="/">About</a></li><li class="nav__item mr-1"><a @click="isOpen = false" class="text-ml inline-block text-gray-500 no-underline hover:text-indigo-500 py-2 px-4" href="/blog">Blog</a></li><li class="nav__item mr-1"><a @click="isOpen = false" target="_blank" rel="noreferrer noopener" class="text-ml inline-block text-gray-500 no-underline hover:text-indigo-500 py-2 px-4" href="https://twitter.com/psuranas"><i class="fab fa-twitter"></i></a></li><li class="nav__item mr-1"><a @click="isOpen = false" target="_blank" rel="noreferrer noopener" class="text-ml inline-block text-gray-500 no-underline hover:text-indigo-500 py-2 px-4" href="https://github.com/prateek3255"><i class="fab fa-github"></i></a></li><li class="nav__item mr-1"><a @click="isOpen = false" target="_blank" rel="noreferrer noopener" class="text-ml inline-block text-gray-500 no-underline hover:text-indigo-500 py-2 px-4" href="https://stackoverflow.com/users/8252081/prateek-surana"><i class="fab fa-stack-overflow"></i></a></li><li class="nav__item mr-1"><a @click="isOpen = false" target="_blank" rel="noreferrer noopener" class="text-ml inline-block text-gray-500 no-underline hover:text-indigo-500 py-2 px-4" href="/blog/feed.xml"><i class="fas fa-rss"></i></a></li></ul></div></nav></div><script>function navbarData(){return{isOpen:!1,handleToggle(){this.isOpen=!this.isOpen,void 0!==window.annotationGroup&&(window.annotationGroup.hide(),setTimeout(()=>{window.annotationGroup.show()},800))}}}</script><div x-data="newsletter()" x-init="startTimer()"><div class="container max-w-3xl mt-6 px-6"><div class="pb-5 mb-5 border-b border-gray-100"><h1 class="font-bold text-5xl">Integrating reCAPTCHA with Next.js</h1><p class="text-center text-base leading-6 font-medium text-gray-500">Last updated on <time>17 Jan 2021</time> by Prateek Surana &nbsp; • &nbsp;<span class="read-time"> - min read</span></p></div><article class="prose lg:prose-xl my-4 relative"><p>In this post on integrating reCAPTCHA with Next.js, we will be looking at what is a CAPTCHA, how does it work and why you might need it. Then we'll work on a demo to illustrate how you can take advantage of Next.js features to integrate it nicely with your website.</p><p>So you must've probably seen this before, but have you ever wondered what it does?</p><picture><source type="image/webp" srcset="/img/captcha-intro-480.webp 480w, /img/captcha-intro-768.webp 768w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><source type="image/jpeg" srcset="/img/captcha-intro-480.jpeg 480w, /img/captcha-intro-768.jpeg 768w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><img src="../img/captcha-intro-768.jpeg" width="768" height="1114" alt="A regular reCAPTCHA" class="max-w-full lg:max-w-md mx-auto" loading="lazy" decoding="async"></picture><p>A CAPTCHA is a <a href="https://en.wikipedia.org/wiki/Turing_test">Turing test</a> designed to tell humans and bots apart and is generally used by websites to prevent spam and abuse. It uses a challenge that is easy for humans but hard for bots.</p><p><a href="https://www.google.com/recaptcha/about/">reCAPTCHA</a> is a CAPTCHA system currently being maintained by Google. The currently maintained versions are v2, which uses an analysis of cookies, canvas rendering, and user behavior to decide whether to show a challenge or not, and v3, which does not interrupt the users at all.</p><p>To get the full benefits of reCAPTCHA, you need to verify the captcha response code in the server to verify its validity. With Next.js, this could have never been easier since it easily lets you spin up a serverless function (if you're deploying it via Vercel) just by adding an <a href="https://nextjs.org/docs/api-routes/introduction">API route in the <code>/pages/api/</code> folder</a>.</p><blockquote><p>This post assumes you are familiar with the basics of React and Next.js. If not, I would recommend checking out the <a href="https://reactjs.org/tutorial/tutorial.html">Intro to React Tutorial by the React team</a> and the <a href="https://nextjs.org/learn/basics/create-nextjs-app">Next.js tutorial from the docs</a>.</p></blockquote><p>reCAPTCHA, though more famous than any other solutions out there but is <a href="https://www.fastcompany.com/90369697/googles-new-recaptcha-has-a-dark-side">infamous for its privacy-related concerns</a>. So if you are concerned about your user's privacy, we will also be looking at a privacy-friendly alternative to reCAPTCHA called <a href="https://hcaptcha.com">hCaptcha</a> later in this post.</p><p>We will cover this with the following steps -</p><ol><li><a href="#why-you-need-to-use-recaptcha-and-how-does-it-work">Why you need to use reCAPTCHA and how does it work</a></li><li><a href="#setting-up-the-project">Setting up the project</a></li><li><a href="#adding-recaptcha-to-the-frontend">Adding reCAPTCHA to the frontend</a></li><li><a href="#verifying-captcha-via-nextjs-api-routes">Verifying captcha via Next.js' API routes</a></li><li><a href="#bonus-integrating-hcaptcha-and-why-you-might-need-it">Bonus: Integrating hCaptcha and why you might need it</a></li></ol><h2 class="relative"><a id="why-you-need-to-use-recaptcha-and-how-does-it-work" href="#why-you-need-to-use-recaptcha-and-how-does-it-work" class="header-anchor"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="absolute top-2 -left-7 opacity-0 icon" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg> Why you need to use reCAPTCHA and how does it work</a></h2><p>Before we dive into integrating reCAPTCHA, let's take a moment to understand why you need it and how does it solve your problems.</p><p>If you have a public-facing page with a form that sends the data to your backend server, then adding reCAPTCHA can help you to prevent spammers/bots from flooding your form and thus polluting your database or prevent something like brute force password guessing attack on a login page. Although reCAPTCHA is not the only way to prevent such malicious requests, there are other ways you can <a href="https://elasticemail.com/blog/marketing_tips/how-to-prevent-bots-from-spamming-your-sign-up-forms">prevent spam without disturbing your users</a>. Still, reCAPTCHA is really smart and only shows a challenge if your user fails its cookie and behavior analysis.</p><p>The way it works is as soon as the user submits the form, you execute the reCAPTCHA instead of sending the data directly to your backend. In turn, reCAPTCHA provides you a callback for both success and failure, which will be executed if the user passes or fails the reCAPTCHA, respectively.</p><p>Now this will prevent your frontend from malicious attacks. However, your backend APIs might still be insecure (assuming you are not using any other kind of protection, e.g., <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">CSRF tokens</a>) because anyone can open the network tab to check the APIs getting pinged and run a script to ping the API with spam data. Thankfully reCAPTCHA provides a solution for that as well. When a user successfully clears the reCAPTCHA, you are provided with a token that is valid for 2 minutes. You can now validate this token in your backend with a secret key to verify the request's authenticity.</p><picture><source type="image/webp" srcset="/img/recaptcha-working-480.webp 480w, /img/recaptcha-working-768.webp 768w, /img/recaptcha-working-1200.webp 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><source type="image/jpeg" srcset="/img/recaptcha-working-480.jpeg 480w, /img/recaptcha-working-768.jpeg 768w, /img/recaptcha-working-1200.jpeg 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><img src="../img/recaptcha-working-768.jpeg" width="768" height="432" alt="Working of reCAPTCHA" class="article-img" loading="lazy" decoding="async"></picture><h2 class="relative"><a id="setting-up-the-project" href="#setting-up-the-project" class="header-anchor"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="absolute top-2 -left-7 opacity-0 icon" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg> Setting up the project</a></h2><p>I will be using a plain starter built using <a href="https://www.npmjs.com/package/create-next-app"><code>create-next-app</code></a> with a simple form. If you want to follow along, you can get the initial state from <a href="https://github.com/prateek3255/recaptch-with-next/tree/4be05a0163a2629b88b6bf8dc6863c9bb29da2a2">this commit</a>. The initial setup looks like this, and it just shows your email in an alert when you click on register</p><picture><source type="image/webp" srcset="/img/initial-recaptcha-app-480.webp 480w, /img/initial-recaptcha-app-768.webp 768w, /img/initial-recaptcha-app-1200.webp 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><source type="image/jpeg" srcset="/img/initial-recaptcha-app-480.jpeg 480w, /img/initial-recaptcha-app-768.jpeg 768w, /img/initial-recaptcha-app-1200.jpeg 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><img src="../img/initial-recaptcha-app-768.jpeg" width="768" height="505" alt="Inital Next.js app" class="article-img" loading="lazy" decoding="async"></picture><p>Let's register a new project on reCAPTCHA and get the required keys. For that, you can go to the <a href="https://www.google.com/recaptcha/admin/create">reCAPTCHA admin console</a>, fill in the required details as mentioned below, and click on submit.</p><blockquote><p>For this post's scope, we will be focusing on the <a href="https://developers.google.com/recaptcha/docs/versions#recaptcha_v2_invisible_recaptcha_badge">v2 Invisible reCAPTCHA</a> which does not involves the reCAPTCHA checkbox. It invokes the prompt to solve captcha for most suspicious traffic via a JavaScript API call and will directly tell us if the user has passed or not.</p><p>v3 reCAPTCHA, though, is more advanced and doesn't require users to solve any challenge, but only provides a score between 0 and 1, requiring you to take action in the context of your site: for instance, requiring additional factors of authentication, sending a post to moderation, or throttling bots that may be scraping content.</p></blockquote><picture><source type="image/webp" srcset="/img/recaptcha-registration-480.webp 480w, /img/recaptcha-registration-768.webp 768w, /img/recaptcha-registration-1200.webp 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><source type="image/jpeg" srcset="/img/recaptcha-registration-480.jpeg 480w, /img/recaptcha-registration-768.jpeg 768w, /img/recaptcha-registration-1200.jpeg 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><img src="../img/recaptcha-registration-768.jpeg" width="768" height="667" alt="Registering your reCAPTCHA site" class="mt-5" loading="lazy" decoding="async"></picture><blockquote><p>Notice how I added the only localhost to the list of domains. That's because we would only be using these keys for development purposes. reCAPTCHA also does a domain validation for the site it is being executed on, so we would be creating a separate set of keys for the production environment to only be used on the production domain and not be misused.</p></blockquote><p>After clicking submit, you should be able to see the public and secret keys.</p><picture><source type="image/webp" srcset="/img/recaptcha-keys-480.webp 480w, /img/recaptcha-keys-768.webp 768w, /img/recaptcha-keys-1200.webp 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><source type="image/jpeg" srcset="/img/recaptcha-keys-480.jpeg 480w, /img/recaptcha-keys-768.jpeg 768w, /img/recaptcha-keys-1200.jpeg 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><img src="../img/recaptcha-keys-768.jpeg" width="768" height="392" alt="reCAPTCHA keys" class="article-img" loading="lazy" decoding="async"></picture><p>To have separate keys for production and development environments and avoid pushing these keys to version control, we would store these keys in the environment variables. Unlike typical react app setups where you would need to manually <a href="https://prateeksurana.me/blog/using-environment-variables-with-webpack/">setup environment variables manually via Webpack plugins</a>, Next.js comes with <a href="https://nextjs.org/docs/basic-features/environment-variables">built-in support for environment variables</a>. For the development environment, create a file called <code>.env.local</code> and add the following to it, and paste the keys you copied from the reCAPTCHA dashboard here appropriately.</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># Add the public site key here</span><br><span class="token assign-left variable">NEXT_PUBLIC_RECAPTCHA_SITE_KEY</span><span class="token operator">=</span><br><span class="token comment"># Add the secret key here</span><br><span class="token assign-left variable">RECAPTCHA_SECRET_KEY</span><span class="token operator">=</span></code></pre><p>You can use different environment keys for production with the proper domains added, either using <code>.env.production.local</code> or adding the production environment variables to the tool (e.g., Vercel) you are using to deploy your app.</p><p><a href="https://github.com/prateek3255/recaptch-with-next/tree/4be05a0163a2629b88b6bf8dc6863c9bb29da2a2">👨🏻‍💻 Code till this step</a></p><h2 class="relative"><a id="adding-recaptcha-to-the-frontend" href="#adding-recaptcha-to-the-frontend" class="header-anchor"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="absolute top-2 -left-7 opacity-0 icon" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg> Adding reCAPTCHA to the frontend</a></h2><p>We need the public site key to be available to the client. Adding the <code>NEXT_PUBLIC_</code> suffix to the environment variable would <a href="https://nextjs.org/docs/basic-features/environment-variables#exposing-environment-variables-to-the-browser">make it visible to the browser</a>. The <code>RECAPTCHA_SECRET_KEY</code> environment variable would only be available on the server.</p><p>We would be using a library called <a href="https://github.com/dozoisch/react-google-recaptcha"><code>react-google-recaptcha</code></a>, a wrapper around reCAPTCHA v2 that provides access to its APIs via a React component. Let's install it -</p><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> react-google-recaptcha</code></pre><p>Since we are using the v2 invisible reCAPTCHA, we would be executing it when we submit the form via a <a href="https://reactjs.org/docs/hooks-reference.html#useref">React ref</a>. Import the ReCAPTCHA component and place it in the <code>pages/index.js</code> file, like this -</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> Head <span class="token keyword">from</span> <span class="token string">"next/head"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> ReCAPTCHA <span class="token keyword">from</span> <span class="token string">"react-google-recaptcha"</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>email<span class="token punctuation">,</span> setEmail<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> recaptchaRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">.</span><br>  <span class="token punctuation">.</span><br>  <span class="token punctuation">.</span><br>  <span class="token punctuation">.</span><br>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>	  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReCAPTCHA</span></span><br>	    <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>recaptchaRef<span class="token punctuation">}</span></span><br>	    <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>invisible<span class="token punctuation">"</span></span><br>	    <span class="token attr-name">sitekey</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_PUBLIC_RECAPTCHA_SITE_KEY</span><span class="token punctuation">}</span></span><br>      <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onReCAPTCHAChange<span class="token punctuation">}</span></span><br>	  <span class="token punctuation">/></span></span><span class="token plain-text"><br>	  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span><br>	    <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span></span><br>	    <span class="token attr-name">required</span><br>	    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><br>	    <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><br>	    <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Email<span class="token punctuation">"</span></span><br>	  <span class="token punctuation">/></span></span><span class="token plain-text"><br>	  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Register</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text"><br>	</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><br> <span class="token punctuation">.</span><br> <span class="token punctuation">.</span><br> <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>For the <code>siteKey</code> we are using the environment variable that we created in the last step.</p><p>We now need to execute the reCAPTCHA when submitting the form and do what we want when our form is submitted in the <code>ReCAPTCHA</code> component's <code>onChange</code> handler when the captcha is completed. So let's modify the <code>handleSubmit</code> function and define the <code>onReCAPTCHAChange</code> function accordingly in our component -</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">handleSubmit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Execute the reCAPTCHA when the form is submitted</span><br>  recaptchaRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">onReCAPTCHAChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">captchaCode</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// If the reCAPTCHA code is null or undefined indicating that</span><br>  <span class="token comment">// the reCAPTCHA was expired then return early</span><br>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>captchaCode<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// Else reCAPTCHA was executed successfully so proceed with the </span><br>  <span class="token comment">// alert</span><br>  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hey, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Reset the reCAPTCHA so that it can be executed again if user </span><br>  <span class="token comment">// submits another email.</span><br>  recaptchaRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>When you restart the server with <code>yarn dev</code>, if the integration was successful you should see the reCAPTCHA badge at the bottom right corner. And you would be only able to see the alert if you pass the reCAPTCHA.</p><p>Note that if a challenge is not being shown to you, it doesn't necessarily mean that there is something wrong with the integration. As I mentioned earlier, reCAPTCHA only shows a challenge if you fail its behavior or cookie analysis. If you still want to see the challenge anyways, you can open the tab in incognito and update the security preference to most secure from the reCAPTCHA admin dashboard.</p><picture><source type="image/webp" srcset="/img/recaptcha-security-preference-480.webp 480w, /img/recaptcha-security-preference-768.webp 768w, /img/recaptcha-security-preference-1200.webp 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><source type="image/jpeg" srcset="/img/recaptcha-security-preference-480.jpeg 480w, /img/recaptcha-security-preference-768.jpeg 768w, /img/recaptcha-security-preference-1200.jpeg 1200w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><img src="../img/recaptcha-security-preference-768.jpeg" width="768" height="154" alt="reCAPTCHA security preference" class="article-img" loading="lazy" decoding="async"></picture><p>You should be able to see the challenge after submitting a form couple of times in a row.</p><p><img src="/img/recaptcha-in-action.gif" width="768" height="437" alt="reCAPTCHA in action" class="article-img" loading="lazy" decoding="async"></p><p><a href="https://github.com/prateek3255/recaptch-with-next/tree/14f229c3a9567938c2be1181517c48b29fc101cc">👨🏻‍💻 Code till this step</a></p><h2 class="relative"><a id="verifying-captcha-via-nextjs-api-routes" href="#verifying-captcha-via-nextjs-api-routes" class="header-anchor"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="absolute top-2 -left-7 opacity-0 icon" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg> Verifying captcha via Next.js' API routes</a></h2><p>Likely, you don't want to show your user's info in an alert box when he submits your form. You might want to store that info somewhere in your backend instead or provide an appropriate response to the user in case of a login form. For that, we can replace the code that shows the alert with an API call that saves the info the user entered to your backend because we have already added the reCAPTCHA that would prevent any bot or spammers, right?</p><p>Well, not really. As I mentioned in the beginning if you're not using any protection for your API and since the API is most probably open, someone can still run a simple script that continuously pings your API with garbage data polluting your database.</p><p>Don't worry Next.js and reCAPTCHA have you covered.</p><p>Remember the reCAPTCHA token you received in the <code>onReCAPTCHAChange</code> function. That token can be used to verify whether the request you just received is legitimate or not. Google provides an <a href="https://developers.google.com/recaptcha/docs/verify">API for verifying that token</a> in your server via the secret key. The token is valid only for 2 minutes and can only be verified once to prevent any replay attacks.</p><p>So do you need to update your API route that saves the user details or create a new server that would handle the verification if you're relying on some third party API?</p><p>This is where <a href="https://nextjs.org/docs/api-routes/introduction">Next.js' API routes</a> come in. If you're using Vercel for deployment, it spins up a serverless function whenever you create a new API route.</p><p>For our demo, we need an API endpoint that accepts the email and the captcha token and saves the email to the database if the token is valid, and returns an error if it is bogus.</p><p>Let's create our API route, create a file called <code>pages/api/register.js</code> and paste the following in it -</p><pre class="language-jsx"><code class="language-jsx"><span class="token comment">// pages/api/register.js</span><br><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">"node-fetch"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> body<span class="token punctuation">,</span> method <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">;</span><br><br>  <span class="token comment">// Extract the email and captcha code from the request body</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> captcha <span class="token punctuation">}</span> <span class="token operator">=</span> body<span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// If email or captcha are missing return an error</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email <span class="token operator">||</span> <span class="token operator">!</span>captcha<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        message<span class="token operator">:</span> <span class="token string">"Unproccesable request, please provide the required fields"</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Ping the google recaptcha verify API to verify the captcha code you received</span><br>      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><br>        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://www.google.com/recaptcha/api/siteverify?secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">RECAPTCHA_SECRET_KEY</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;response=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>captcha<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>        <span class="token punctuation">{</span><br>          headers<span class="token operator">:</span> <span class="token punctuation">{</span><br>            <span class="token string">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/x-www-form-urlencoded; charset=utf-8"</span><span class="token punctuation">,</span><br>          <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          method<span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">const</span> captchaValidation <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token comment">/**<br>       * The structure of response from the veirfy API is<br>       * {<br>       *  "success": true|false,<br>       *  "challenge_ts": timestamp,  // timestamp of the challenge load (ISO format yyyy-MM-dd'T'HH:mm:ssZZ)<br>       *  "hostname": string,         // the hostname of the site where the reCAPTCHA was solved<br>       *  "error-codes": [...]        // optional<br>        }<br>       */</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>captchaValidation<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Replace this with the API that will save the data received</span><br>        <span class="token comment">// to your backend</span><br>        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token comment">// Return 200 if everything is successful</span><br>        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br><br>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        message<span class="token operator">:</span> <span class="token string">"Unproccesable request, Invalid captcha code"</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">"Something went wrong"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// Return 404 if someone pings the API with a method other than</span><br>  <span class="token comment">// POST</span><br>  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>For simplicity, I have installed a package called <a href="https://www.npmjs.com/package/node-fetch"><code>node-fetch</code></a>, which is a light-weight wrapper that provides the <code>window.fetch</code> like API in Node environment.</p><p>Now let's integrate this API on the client. Update the <code>onReCAPTCHAChange</code> function in the <code>pages/index.js</code> with the following snippet -</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">onReCAPTCHAChange</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">captchaCode</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// If the reCAPTCHA code is null or undefined indicating that</span><br>    <span class="token comment">// the reCAPTCHA was expired then return early</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>captchaCode<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/api/register"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>        method<span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span><br>        body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">,</span> captcha<span class="token operator">:</span> captchaCode <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        headers<span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token string">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// If the response is ok than show the success alert</span><br>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Email registered successfully"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Else throw an error with the message returned</span><br>        <span class="token comment">// from the API</span><br>        <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">alert</span><span class="token punctuation">(</span>error<span class="token operator">?.</span>message <span class="token operator">||</span> <span class="token string">"Something went wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Reset the reCAPTCHA when the request has failed or succeeeded</span><br>      <span class="token comment">// so that it can be executed again if user submits another email.</span><br>      recaptchaRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>To test if the integration is proper, you can replace the captcha code sent to the API with a random string, and you should see this when you click on register.</p><picture><source type="image/webp" srcset="/img/invalid-response-code-480.webp 480w, /img/invalid-response-code-768.webp 768w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><source type="image/jpeg" srcset="/img/invalid-response-code-480.jpeg 480w, /img/invalid-response-code-768.jpeg 768w" sizes="(max-width: 600px) 480px, (max-width: 1024px) 768px, 1200px"><img src="../img/invalid-response-code-768.jpeg" width="768" height="217" alt="Invalid response code" class="article-img" loading="lazy" decoding="async"></picture><p>If you followed along till here, then pat yourself on the back. Your frontend and backend database are now fully secure from any spam or bots.</p><p><a href="https://github.com/prateek3255/recaptch-with-next/tree/a57aadb1dddf4289892c8949de6d8715ba1a07d1">👨🏻‍💻 Code till this step</a></p><h2 class="relative"><a id="bonus-integrating-hcaptcha-and-why-you-might-need-it" href="#bonus-integrating-hcaptcha-and-why-you-might-need-it" class="header-anchor"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="absolute top-2 -left-7 opacity-0 icon" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg> Bonus: Integrating hCAPTCHA and why you might need it</a></h2><p>Although reCAPTCHA might be great for security, but if you're concerned about your user's privacy, then <a href="https://www.hcaptcha.com/">hCaptcha</a> might be a better choice. Do checkout why <a href="https://blog.cloudflare.com/moving-from-recaptcha-to-hcaptcha/">Cloudflare moved from reCAPTCHA to hCaptcha</a>. hCaptcha differs from reCAPTCHA in the following ways:</p><ul><li>They respect for your user's privacy.</li><li>Your visitors will solve problems that benefits many companies for labelling the data instead of a single corporation.</li><li>It's more user friendly and contains a variety of challenges.</li></ul><p>Thanks to hCaptcha's clean and similar to reCAPTCHA APIs, it takes no time to switch from reCAPTCHA to hCaptcha. It literally took me just 15 minutes to go through their docs and replace reCAPTCHA with hCaptcha for our demo.</p><p>The setting up process is very similar to reCAPTCHA. You can go to their <a href="https://www.hcaptcha.com/signup-interstitial">signup page</a> to create an account and get the site key and secret key for your site. I renamed the keys to <code>NEXT_PUBLIC_HCAPTCHA_SITE_KEY</code> and <code>HCAPTCHA_SECRET_KEY</code>, respectively, in the <code>.env.local</code> file.</p><p>They also have a React wrapper component called <a href="https://github.com/hCaptcha/react-hcaptcha"><code>@hcaptcha/react-hcaptcha</code></a>, which also has a very similar API to the React component we used for reCAPTCHA. These are the only changes (apart from renaming reCAPTCHA variables) I had to integrate the component on the client in <code>pages/index.js</code> :</p><pre class="language-jsx"><code class="language-jsx"><span class="token punctuation">.</span><br><span class="token punctuation">.</span><br><span class="token keyword">import</span> HCaptcha <span class="token keyword">from</span> <span class="token string">"@hcaptcha/react-hcaptcha"</span><span class="token punctuation">;</span><br><span class="token punctuation">.</span><br><span class="token punctuation">.</span><br><span class="token punctuation">.</span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HCaptcha</span></span><br>  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span><br>  <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>invisible<span class="token punctuation">"</span></span><br>  <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>hcaptchaRef<span class="token punctuation">}</span></span><br>  <span class="token attr-name">sitekey</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_PUBLIC_HCAPTCHA_SITE_KEY</span><span class="token punctuation">}</span></span><br>  <span class="token attr-name">onVerify</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onHCaptchaChange<span class="token punctuation">}</span></span><br><span class="token punctuation">/></span></span></code></pre><p>For the api route, we just need to change the url and pass the secret and token to the body instead of query params, this is what it looks like in <code>pages/api/register.js</code> :</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><br>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://hcaptcha.com/siteverify</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    headers<span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token string">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/x-www-form-urlencoded; charset=utf-8"</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    body<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">response=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>captcha<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">HCAPTCHA_SECRET_KEY</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>    method<span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Although hCaptcha doesn't work on localhost URLs so you would need to add a <a href="https://docs.hcaptcha.com/#local-development">host entry for localhost</a> according to your system for it to work.</p><p>After that you can just run <code>yarn dev</code>, and visit the URL you added the host entry for localhost to to see hCaptcha in action</p><p><img src="/img/hcaptcha-in-action.gif" width="768" height="436" alt="hCaptcha in action" class="article-img" loading="lazy" decoding="async"></p><p>I created a separate branch in the demo repo, for the hCaptcha integration here -</p><p><a href="https://github.com/prateek3255/recaptch-with-next/tree/integrate-hcaptcha">👨🏻‍💻 Code till this step</a></p><p>I hope this article helped you in gaining some insight on how you can integrate CAPTCHA with your Next.js website and which CAPTCHA service you should prefer.</p><p>You can find the full code for both the <a href="https://github.com/prateek3255/recaptch-with-next">reCAPTCHA</a> and <a href="https://github.com/prateek3255/recaptch-with-next/tree/integrate-hcaptcha">hCaptcha</a> integration on GitHub.</p><a class="fixed bottom-12 bg-white text-accent-blue flex items-center justify-center rounded cursor-pointer z-10 invisible lg:visible top-indicator-container" aria-label="Scroll to top" href="#"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="top-indicator" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M256 217.9L383 345c9.4 9.4 24.6 9.4 33.9 0 9.4-9.4 9.3-24.6 0-34L273 167c-9.1-9.1-23.7-9.3-33.1-.7L95 310.9c-4.7 4.7-7 10.9-7 17s2.3 12.3 7 17c9.4 9.4 24.6 9.4 33.9 0l127.1-127z"></path></svg></a></article><hr class="my-4"><div class="text-md mb-3 flex justify-between flex-col md:flex-row"><div><a href="/blog/tags/next-js" onclick='trackTagClick("next-js")' class="text-indigo-700 mr-1">#Next.js </a><a href="/blog/tags/react" onclick='trackTagClick("react")' class="text-indigo-700 mr-1">#React </a><a href="/blog/tags/tutorial" onclick='trackTagClick("tutorial")' class="text-indigo-700 mr-1">#Tutorial</a></div><div class="mt-2 md:mt-0"><span class="font-bold mr-2">Enjoyed this blog, share it on: </span><a href="https://twitter.com/intent/tweet?url=undefined/blog/integrating-recaptcha-with-next/&via=psuranas&text=Integrating reCAPTCHA with Next.js" target="_blank" rel="noreferrer noopener" class="text-indigo-700 mr-1">Twitter </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=undefined/blog/integrating-recaptcha-with-next/" target="_blank" rel="noreferrer noopener" class="text-indigo-700">LinkedIn</a></div></div></div><div class="container max-w-3xl border-gray-100 border-2 p-8 shadow rounded flex flex-col items-center md:flex-row mb-6 mt-8 bg-blue-100"><div class="text-center"><h4 class="text-lg font-bold mb-2">Want to get better at React, JavaScript, and TypeScript?</h4><p class="text-base">I regularly publish posts like this one, containing best practices, tips, and tutorials on React, JavaScript, and TypeScript. Subscribe to my newsletter to get them straight to your inbox. No spam ever. Unsubscribe at any time. You can also <a target="_blank" rel="noreferrer noopener" class="underline" href="/blog/feed.xml">subscribe via RSS</a>.</p><form x-on:submit="handleSubscribe" name="subscribe_card"><input name="email" x-model="emailField" required type="email" placeholder="john@doe.com" class="input-primary mt-6"> <button x-bind:disabled="isSubscribeLoading" class="btn-primary" type="submit">Count me in</button></form></div></div><div class="container max-w-3xl border-gray-100 border-2 p-8 shadow rounded flex flex-col items-center md:flex-row mb-6 mt-8"><div class="mb-4 md:mb-0 md:mr-8 md:flex-shrink-0"><img alt="Prateek Surana" height="20" width="20" class="h-20 w-20 rounded-full border-indigo-500 border-2" src="/img/prateek-author.jpg"></div><div class="md:text-left text-center"><h4 class="text-lg font-bold mb-2 md:mb-0">About Prateek Surana</h4><p class="text-base">Prateek is a Frontend Engineer and an iOS developer, currently building <a href="https://devfolio.co" class="text-indigo-700" target="_blank" rel="noreferrer noopener">Devfolio</a>. Apart from his unconditional love for JavaScript and React, he also enjoys watching Marvel movies and playing quirky games on his phone.</p></div></div><div x-cloak x-show.transition.duration.300ms="showSubscribePopup" class="fixed border-gray-100 border-2 p-6 shadow rounded bottom-7 right-7 w-72 ml-auto xl:block hidden bg-blue-100 z-20"><img src="/img/subscribe-banner-image.png" alt="Subscribe to newsletter" style="top:-130px; right:79px;" class="absolute h-32"><div class="flex w-full justify-between mb-2"><h4 class="text-lg font-bold mb-2">Want to get better at React, JavaScript, and TypeScript?</h4><img src="/img/cross-black.svg" x-on:click="hideSubscribePopup" alt="Close the banner" class="h-5 mt-1 cursor-pointer"></div><p class="text-base">I regularly publish posts like this one, containing best practices, tips, and tutorials on React, JavaScript, and TypeScript.</p><br><p class="text-base">Subscribe to my newsletter to get them straight to your inbox. No spam ever. Unsubscribe at any time.</p><form x-on:submit="handleSubscribe" name="subscribe_popup"><input name="email" x-model="emailField" required type="email" placeholder="john@doe.com" class="input-primary mt-6"> <button x-bind:disabled="isSubscribeLoading" class="btn-primary" type="submit">Count me in</button></form></div></div><script>function newsletter(){return{showSubscribePopup:!1,isSubscribeLoading:!1,emailField:"",hideSubscribePopup(){trackEvent("closed_subscribe_popup","subscribe"),this.showSubscribePopup=!1,localStorage.setItem("has-hidden-subscription-popup",!0)},handleSubscribe(e){e.preventDefault(),trackEvent(`clicked_on_subscribe_from_${e.target.name}`,"subscribe",e.target.name),this.isSubscribeLoading=!0;fetch("http://localhost:3000/api/register",{method:"POST",body:JSON.stringify({email:this.emailField})}).then(e=>e.json()).then(e=>{this.isSubscribeLoading=!1,this.emailField="",e.success?(window.location.href="undefined/confirm",this.showSubscribePopup=!1,localStorage.setItem("has-hidden-subscription-popup",!0)):alert(e.message)}).catch(e=>{this.isSubscribeLoading=!1,alert("Something went wrong, please refresh the page and try again!")})},startTimer(){clearTimeout(window.currentTimer),localStorage.getItem("has-hidden-subscription-popup")||(window.currentTimer=setTimeout(()=>{this.showSubscribePopup=!0},15e3),window.onscroll=()=>{document.body.offsetHeight-(window.innerHeight+window.scrollY)<=550&&(this.showSubscribePopup=!1)})}}}</script><footer class="bottom-0 text-center w-full py-8 px-1 md:px-0"><small class="text-gray-500">Copyright © Prateek&#39;s Blog <span id="copyright"><script>document.getElementById("copyright").appendChild(document.createTextNode((new Date).getFullYear()))</script></span>. Made with <a href="https://www.11ty.dev/" target="_blank" rel="noreferrer noopener" class="underline">Eleventy,</a> <a href="https://tailwindcss.com/" target="_blank" rel="noreferrer noopener" class="underline">Tailwind CSS</a>, and ❤&nbsp; by <a href="https://prateeksurana.me/" target="_blank" rel="noreferrer noopener" class="underline">Prateek Surana</a> • <a href="https://github.com/prateek3255/blog/edit/master/./src/blog/integrating-recaptcha-with-nextjs.md" class="underline" target="_blank" rel="noreferrer noopener">Edit this page on GitHub</a></small></footer><script>var textContent,str,wordCount,readingTimeInMinutes,readingTimeAsString,article=document.getElementsByTagName("article")[0],readTime=document.getElementsByClassName("read-time")[0];article&&readTime&&(wordCount=(str=(str=(str=(textContent=article.textContent).replace(/(^\s*)|(\s*$)/gi,"")).replace(/[ ]{2,}/gi," ")).replace(/\\n /,"\\n")).split(" ").filter(e=>"\\n"!==e).length,readingTimeInMinutes=Math.floor(wordCount/228)+1,readTime.innerText=readingTimeAsString=readingTimeInMinutes+" min read")</script></body></html>